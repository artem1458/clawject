#!/usr/bin/env node

const fs = require('fs');
const packageJson = require('../package.json');

const constantsFile = fs.readFileSync('src/constants/index.ts', 'utf8');
const tsVersionRange = constantsFile.match(/TS_VERSION_RANGE = '(.*)'/)[1];

const libraryVersion = process.env.NPM_PACKAGE_VERSION || '0.0.0';

packageJson.version = libraryVersion;
packageJson.peerDependencies = {
  typescript: tsVersionRange
};

const cjsPackageJson = {
  type: "commonjs",
  version: libraryVersion,
}
const esmPackageJson = {
  type: "module",
  version: libraryVersion,
}

fs.writeFileSync('dist/package.json', JSON.stringify(packageJson, null, 2));
fs.writeFileSync('dist/dist/cjs/package.json', JSON.stringify(cjsPackageJson, null, 2));
fs.writeFileSync('dist/dist/esm/package.json', JSON.stringify(esmPackageJson, null, 2));
fs.writeFileSync('src/constants/index.ts', constantsFile.replace(/LIBRARY_VERSION = '(.*)'/, `LIBRARY_VERSION = '${libraryVersion}'`));
